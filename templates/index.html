<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Geotab - Arval Colombia</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
        }
        
        .header {
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-nav {
            display: flex;
            gap: 10px;
        }
        
        .header-nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .header-nav a:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .sidebar-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .sidebar-tab {
            flex: 1;
            padding: 12px 10px;
            border: none;
            background: #e3f2fd;
            color: #1a73e8;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .sidebar-tab:hover {
            background: #bbdefb;
        }
        
        .sidebar-tab.active {
            background: #1a73e8;
            color: white;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        .sidebar {
            width: 350px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group select, .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: #1a73e8;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0d47a1;
        }
        
        .btn-success {
            background: #34a853;
            color: white;
        }
        
        .btn-success:hover {
            background: #2d8a46;
        }
        
        .btn-order {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #1a73e8;
            background: white;
            color: #1a73e8;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .btn-order:hover {
            background: #e3f2fd;
        }
        
        .btn-order.active {
            background: #1a73e8;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card .number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #1a73e8;
        }
        
        .stat-card .label {
            font-size: 0.8rem;
            color: #666;
        }
        
        .vehicle-list {
            margin-top: 10px;
            max-height: 350px;
            overflow-y: auto;
        }
        
        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .search-box input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.15);
        }
        
        .search-box button {
            padding: 10px 15px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .search-box button:hover {
            background: #0d47a1;
        }
        
        .vehicle-item {
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .vehicle-item:hover {
            background: #e3f2fd;
            border-color: #1a73e8;
        }
        
        .vehicle-item .placa {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .vehicle-item .info {
            font-size: 0.8rem;
            color: #666;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-dot.online {
            background: #34a853;
            box-shadow: 0 0 5px #34a853;
        }
        
        .status-dot.offline {
            background: #ea4335;
        }
        
        .trip-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #1a73e8;
            transition: all 0.3s ease;
            position: relative;
        }
        .viaje-seleccionable {
            cursor: pointer;
            user-select: none;
        }
        .viaje-seleccionable:not(.seleccionado) {
            opacity: 0.35;
            background: #e8e8e8;
            border-left-width: 3px;
            transform: scale(0.98);
        }
        .viaje-seleccionable.seleccionado {
            opacity: 1;
            background: linear-gradient(to right, #ffffff, #f8f9fa);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.4), 0 0 0 2px rgba(26, 115, 232, 0.2);
            border-left-width: 5px;
            transform: scale(1);
        }
        .viaje-seleccionable.seleccionado::before {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #34a853;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .viaje-seleccionable:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }
        
        .trip-card h4 {
            color: #1a73e8;
            margin-bottom: 10px;
        }
        
        .trip-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .loader {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loader .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .section-title {
            font-size: 1rem;
            color: #333;
            margin: 20px 0 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #1a73e8;
        }
        
        #panel-ubicaciones, #panel-viajes {
            display: none;
        }
        
        #panel-ubicaciones.active, #panel-viajes.active {
            display: block;
        }
        
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 0.85rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöó GPS Geotab - Arval Colombia</h1>
        <div class="header-nav">
            <a href="/">üó∫Ô∏è Mapa</a>
            <a href="/estadisticas">üìä Estad√≠sticas</a>
        </div>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <!-- Tabs en el sidebar -->
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" onclick="showPanel('ubicaciones')">üìç Ubicaciones</button>
                <button class="sidebar-tab" onclick="showPanel('viajes')">üõ£Ô∏è Viajes</button>
            </div>
            
            <!-- Panel Ubicaciones -->
            <div id="panel-ubicaciones" class="active">
                <button class="btn btn-success" onclick="cargarUbicaciones()">
                    üîÑ Actualizar Ubicaciones
                </button>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number" id="total-vehiculos">-</div>
                        <div class="label">Veh√≠culos</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="total-activos">-</div>
                        <div class="label">Comunicando</div>
                    </div>
                </div>
                
                <h3 class="section-title">Lista de Veh√≠culos</h3>
                <div class="search-box">
                    <input type="text" id="buscar-vehiculo" placeholder="Buscar placa..." onkeyup="filtrarVehiculos()">
                    <button onclick="filtrarVehiculos()">üîç</button>
                </div>
                <div style="margin-bottom: 10px; display: flex; gap: 5px;">
                    <button class="btn-order active" id="btn-orden-placa" onclick="ordenarVehiculos('placa')">üìã Por Placa</button>
                    <button class="btn-order" id="btn-orden-fecha" onclick="ordenarVehiculos('fecha')">üïê Por Reporte</button>
                </div>
                <div class="vehicle-list" id="lista-vehiculos">
                    <div class="loader">
                        <div class="spinner"></div>
                        Cargando veh√≠culos...
                    </div>
                </div>
            </div>
            
            <!-- Panel Viajes -->
            <div id="panel-viajes">
                <div class="form-group">
                    <label>Seleccionar Placa</label>
                    <select id="select-placa">
                        <option value="">Cargando placas...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Fecha</label>
                    <input type="date" id="select-fecha">
                </div>
                
                <button class="btn btn-primary" onclick="cargarViajes()">
                    üîç Buscar Viajes
                </button>
                
                <button class="btn btn-success" onclick="cargarRecorrido()">
                    üó∫Ô∏è Ver Recorrido en Mapa
                </button>
                
                <!-- Resumen del d√≠a completo -->
                <div id="resumen-dia" style="display: none; margin-top: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; padding: 15px; color: white;">
                    <h4 style="margin: 0 0 10px 0; font-size: 1rem;">üìÖ Resumen del D√≠a</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85rem;">
                        <div>
                            <div style="opacity: 0.8;">üü¢ Primer encendido</div>
                            <div id="dia-inicio" style="font-weight: bold;">--:--</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8;">üî¥ √öltimo apagado</div>
                            <div id="dia-fin" style="font-weight: bold;">--:--</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8;">‚è±Ô∏è Tiempo activo</div>
                            <div id="dia-tiempo" style="font-weight: bold;">--</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8;">üìè Distancia total</div>
                            <div id="dia-distancia" style="font-weight: bold;">-- km</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="opacity: 0.8;">üöó Total viajes:</span>
                            <span id="dia-viajes" style="font-weight: bold;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <span style="opacity: 0.8;">üìç Total reportes:</span>
                            <span id="dia-reportes" style="font-weight: bold;">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid" id="stats-viajes" style="display: none;">
                    <div class="stat-card">
                        <div class="number" id="total-viajes">0</div>
                        <div class="label">Viajes</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="total-km">0</div>
                        <div class="label">Km Total</div>
                    </div>
                </div>
                
                <h3 class="section-title">Detalle de Viajes</h3>
                <div id="lista-viajes">
                    <p style="color: #666; text-align: center; padding: 20px;">
                        Selecciona una placa y fecha para ver los viajes
                    </p>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="legend">
                <strong>Leyenda</strong>
                <div class="legend-item">
                    <span class="status-dot online"></span> Comunicando
                </div>
                <div class="legend-item">
                    <span class="status-dot offline"></span> Sin comunicaci√≥n
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Inicializar mapa centrado en Colombia
        const map = L.map('map').setView([4.6097, -74.0817], 6);
        
        // Capas de mapa
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        });
        
        const satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            attribution: '¬© Google',
            maxZoom: 20
        });
        
        // A√±adir capa por defecto
        osmLayer.addTo(map);
        
        // Control de capas
        const baseLayers = {
            "üó∫Ô∏è Mapa": osmLayer,
            "üõ∞Ô∏è Sat√©lite": satelliteLayer
        };
        
        L.control.layers(baseLayers).addTo(map);
        
        let markers = [];
        let polyline = null;
        let vehiculosData = [];
        
        // √çconos personalizados
        const iconOnline = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: #34a853; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">üöó</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        const iconOffline = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: #ea4335; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">üöó</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        // Mostrar panel
        function showPanel(panel) {
            document.querySelectorAll('.sidebar-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#panel-ubicaciones, #panel-viajes').forEach(p => p.classList.remove('active'));
            
            document.getElementById('panel-' + panel).classList.add('active');
            event.target.classList.add('active');
            
            if (panel === 'ubicaciones') {
                cargarUbicaciones();
            } else if (panel === 'viajes') {
                // Limpiar mapa al entrar a viajes
                limpiarMapa();
                map.setView([4.6097, -74.0817], 6);
            }
        }
        
        // Variable para el orden actual
        let ordenActual = 'placa';
        
        // Cargar ubicaciones
        async function cargarUbicaciones() {
            limpiarMapa();
            
            document.getElementById('lista-vehiculos').innerHTML = `
                <div class="loader">
                    <div class="spinner"></div>
                    Cargando ubicaciones...
                </div>
            `;
            
            try {
                const response = await fetch('/api/ubicaciones');
                const ubicaciones = await response.json();
                
                vehiculosData = ubicaciones;
                
                // Aplicar ordenamiento actual
                ordenarYMostrar(ordenActual);
                
            } catch (error) {
                document.getElementById('lista-vehiculos').innerHTML = `
                    <p style="color: red;">Error al cargar ubicaciones: ${error.message}</p>
                `;
            }
        }
        
        // Ordenar y mostrar veh√≠culos
        function ordenarYMostrar(criterio) {
            if (!vehiculosData || vehiculosData.length === 0) return;
            
            let datosOrdenados = [...vehiculosData];
            
            if (criterio === 'placa') {
                datosOrdenados.sort((a, b) => (a.placa || '').localeCompare(b.placa || ''));
            } else if (criterio === 'fecha') {
                datosOrdenados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            }
            
            let html = '';
            let activos = 0;
            const bounds = [];
            
            // Limpiar marcadores previos
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            datosOrdenados.forEach(v => {
                if (v.encendido) activos++;
                
                // Crear marcador
                const marker = L.marker([v.lat, v.lng], {
                    icon: v.encendido ? iconOnline : iconOffline
                }).addTo(map);
                
                const fecha = new Date(v.fecha).toLocaleString('es-CO');
                marker.bindPopup(`
                    <strong style="font-size: 1.2rem;">${v.placa}</strong><br>
                    <b>IMEI:</b> ${v.serial || 'N/A'}<br>
                    <b>Velocidad:</b> ${v.velocidad} km/h<br>
                    <b>√öltima actualizaci√≥n:</b><br>${fecha}<br>
                    <b>Estado:</b> ${v.encendido ? 'üü¢ Comunicando' : 'üî¥ Sin comunicaci√≥n'}
                `);
                
                markers.push(marker);
                bounds.push([v.lat, v.lng]);
                
                // Lista
                const fechaObj = new Date(v.fecha);
                const a√±o = fechaObj.getFullYear();
                const mes = String(fechaObj.getMonth() + 1).padStart(2, '0');
                const dia = String(fechaObj.getDate()).padStart(2, '0');
                const hora = String(fechaObj.getHours()).padStart(2, '0');
                const min = String(fechaObj.getMinutes()).padStart(2, '0');
                const seg = String(fechaObj.getSeconds()).padStart(2, '0');
                const fechaFormato = `${a√±o}-${mes}-${dia} ${hora}:${min}:${seg}`;
                html += `
                    <div class="vehicle-item" onclick="centrarVehiculo(${v.lat}, ${v.lng}, '${v.placa}')" data-placa="${v.placa}" data-serial="${v.serial || ''}">
                        <div>
                            <div class="placa">${v.placa}</div>
                            <div class="info">${v.velocidad} km/h - ${fechaFormato}</div>
                            <div class="info" style="font-size: 0.7rem; color: #888;">IMEI: ${v.serial || 'N/A'}</div>
                        </div>
                        <span class="status-dot ${v.encendido ? 'online' : 'offline'}"></span>
                    </div>
                `;
            });
            
            document.getElementById('lista-vehiculos').innerHTML = html || '<p>No hay veh√≠culos</p>';
            document.getElementById('total-vehiculos').textContent = vehiculosData.length;
            document.getElementById('total-activos').textContent = activos;
            
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        // Ordenar veh√≠culos
        function ordenarVehiculos(criterio) {
            ordenActual = criterio;
            
            // Actualizar botones activos
            document.getElementById('btn-orden-placa').classList.toggle('active', criterio === 'placa');
            document.getElementById('btn-orden-fecha').classList.toggle('active', criterio === 'fecha');
            
            ordenarYMostrar(criterio);
        }
        
        // Filtrar veh√≠culos
        function filtrarVehiculos() {
            const busqueda = document.getElementById('buscar-vehiculo').value.toLowerCase();
            const items = document.querySelectorAll('.vehicle-item');
            
            items.forEach(item => {
                const placa = item.querySelector('.placa').textContent.toLowerCase();
                const serial = (item.dataset.serial || '').toLowerCase();
                item.style.display = (placa.includes(busqueda) || serial.includes(busqueda)) ? 'flex' : 'none';
            });
        }
        
        // Centrar en veh√≠culo
        function centrarVehiculo(lat, lng, placa) {
            map.setView([lat, lng], 16);
            markers.forEach(m => {
                if (m.getPopup().getContent().includes(placa)) {
                    m.openPopup();
                }
            });
        }
        
        // Cargar dispositivos para select
        async function cargarDispositivos() {
            try {
                const response = await fetch('/api/dispositivos');
                const dispositivos = await response.json();
                
                const select = document.getElementById('select-placa');
                select.innerHTML = '<option value="">-- Seleccionar placa --</option>';
                
                dispositivos.forEach(d => {
                    select.innerHTML += `<option value="${d.placa}">${d.placa}</option>`;
                });
            } catch (error) {
                console.error('Error cargando dispositivos:', error);
            }
        }
        
        // Cargar viajes
        async function cargarViajes() {
            const placa = document.getElementById('select-placa').value;
            const fecha = document.getElementById('select-fecha').value;
            
            if (!placa || !fecha) {
                alert('Selecciona una placa y una fecha');
                return;
            }
            
            document.getElementById('lista-viajes').innerHTML = `
                <div class="loader">
                    <div class="spinner"></div>
                    Cargando viajes...
                </div>
            `;
            
            try {
                const response = await fetch(`/api/viajes?placa=${placa}&fecha=${fecha}`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('lista-viajes').innerHTML = `<p style="color: red;">${data.error}</p>`;
                    return;
                }
                
                document.getElementById('stats-viajes').style.display = 'grid';
                document.getElementById('total-viajes').textContent = data.total_viajes;
                
                let totalKm = 0;
                let html = '';
                
                // Agregar bot√≥n de seleccionar todos
                html += `
                    <div style="margin-bottom: 10px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" style="font-size: 0.85rem; padding: 6px 12px;" onclick="seleccionarTodosViajes(true)">‚òëÔ∏è Seleccionar Todos</button>
                        <button class="btn btn-secondary" style="font-size: 0.85rem; padding: 6px 12px;" onclick="seleccionarTodosViajes(false)">‚ùå Deseleccionar</button>
                    </div>
                `;
                
                data.viajes.forEach((viaje, i) => {
                    totalKm += viaje.distancia_km;
                    const inicio = new Date(viaje.inicio).toLocaleTimeString('es-CO');
                    const fin = new Date(viaje.fin).toLocaleTimeString('es-CO');
                    
                    html += `
                        <div class="trip-card viaje-seleccionable seleccionado" data-viaje-index="${i}" style="border-left-color: ${coloresViajes[i % coloresViajes.length]};" onclick="toggleViajeSeleccion(${i})">
                            <h4 style="color: ${coloresViajes[i % coloresViajes.length]}; margin: 0 0 8px 0;">Viaje ${viaje.viaje_num || i + 1}</h4>
                            <div class="trip-detail">
                                <span>üü¢ Ignition ON:</span>
                                <span>${inicio}</span>
                            </div>
                            <div class="trip-detail">
                                <span>üî¥ Ignition OFF:</span>
                                <span>${fin}</span>
                            </div>
                            <div class="trip-detail">
                                <span>üìè Distancia:</span>
                                <span>${viaje.distancia_km} km</span>
                            </div>
                            <div class="trip-detail">
                                <span>‚è±Ô∏è Duraci√≥n:</span>
                                <span>${viaje.duracion_min} min</span>
                            </div>
                            <div class="trip-detail">
                                <span>üöÄ Vel. M√°x:</span>
                                <span>${viaje.velocidad_max} km/h</span>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('total-km').textContent = totalKm.toFixed(1);
                document.getElementById('lista-viajes').innerHTML = html || '<p>No hay viajes en esta fecha</p>';
                
                // Calcular y mostrar resumen del d√≠a
                if (data.viajes.length > 0) {
                    const primerViaje = data.viajes[0];
                    const ultimoViaje = data.viajes[data.viajes.length - 1];
                    
                    const primerEncendido = new Date(primerViaje.inicio);
                    const ultimoApagado = new Date(ultimoViaje.fin);
                    
                    // Formatear horas
                    const formatoHora = (fecha) => {
                        const h = String(fecha.getHours()).padStart(2, '0');
                        const m = String(fecha.getMinutes()).padStart(2, '0');
                        const s = String(fecha.getSeconds()).padStart(2, '0');
                        return `${h}:${m}:${s}`;
                    };
                    
                    // Calcular tiempo total activo (suma de duraciones)
                    let tiempoTotalMin = 0;
                    data.viajes.forEach(v => tiempoTotalMin += v.duracion_min || 0);
                    const horas = Math.floor(tiempoTotalMin / 60);
                    const mins = Math.round(tiempoTotalMin % 60);
                    const tiempoFormato = horas > 0 ? `${horas}h ${mins}m` : `${mins} min`;
                    
                    // Mostrar resumen
                    document.getElementById('resumen-dia').style.display = 'block';
                    document.getElementById('dia-inicio').textContent = formatoHora(primerEncendido);
                    document.getElementById('dia-fin').textContent = formatoHora(ultimoApagado);
                    document.getElementById('dia-tiempo').textContent = tiempoFormato;
                    document.getElementById('dia-distancia').textContent = totalKm.toFixed(1) + ' km';
                    document.getElementById('dia-viajes').textContent = data.total_viajes;
                    document.getElementById('dia-reportes').textContent = '...'; // Se actualizar√° con el recorrido
                } else {
                    document.getElementById('resumen-dia').style.display = 'none';
                }
                
                // Guardar datos de viajes para usar despu√©s
                window.viajesActuales = data;
                
                // Mostrar todos los viajes por defecto
                await mostrarViajesSeleccionados();
                
            } catch (error) {
                document.getElementById('lista-viajes').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        // Colores para los viajes
        const coloresViajes = [
            '#1a73e8', // Azul
            '#ea4335', // Rojo
            '#34a853', // Verde
            '#fbbc04', // Amarillo
            '#9c27b0', // P√∫rpura
            '#ff5722', // Naranja
            '#00bcd4', // Cyan
            '#e91e63', // Rosa
            '#795548', // Marr√≥n
            '#607d8b'  // Gris azulado
        ];
        
        let polylines = []; // Para guardar todas las l√≠neas de viajes
        
        // Cargar recorrido
        async function cargarRecorrido() {
            const placa = document.getElementById('select-placa').value;
            const fecha = document.getElementById('select-fecha').value;
            
            if (!placa || !fecha) {
                alert('Selecciona una placa y una fecha');
                return;
            }
            
            limpiarMapa();
            
            try {
                const response = await fetch(`/api/recorrido?placa=${placa}&fecha=${fecha}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                if (!data.viajes || data.viajes.length === 0) {
                    alert('No hay datos de recorrido para esta fecha');
                    return;
                }
                
                const allBounds = [];
                
                // Dibujar cada viaje con un color diferente
                data.viajes.forEach((viaje, index) => {
                    const color = coloresViajes[index % coloresViajes.length];
                    const puntos = viaje.puntos.map(p => [p.lat, p.lng]);
                    
                    if (puntos.length > 0) {
                        // L√≠nea del viaje
                        const line = L.polyline(puntos, {
                            color: color,
                            weight: 4,
                            opacity: 0.8
                        }).addTo(map);
                        polylines.push(line);
                        
                        puntos.forEach(p => allBounds.push(p));
                        
                        // Puntos intermedios (cada reporte GPS)
                        viaje.puntos.forEach((punto, pIndex) => {
                            // Saltar el primero y √∫ltimo (tienen marcadores especiales)
                            if (pIndex > 0 && pIndex < viaje.puntos.length - 1) {
                                const ignicion = punto.ignicion ? 'üü¢ Ignition ON' : 'üî¥ Ignition OFF';
                                const markerPunto = L.circleMarker([punto.lat, punto.lng], {
                                    radius: 6,
                                    fillColor: punto.ignicion ? color : '#666',
                                    color: '#fff',
                                    weight: 2,
                                    opacity: 1,
                                    fillOpacity: 0.9
                                }).addTo(map).bindPopup(`
                                    <b style="color: ${color};">üìç Punto #${punto.num || pIndex + 1}</b><br>
                                    <b>Viaje:</b> ${viaje.viaje_num}<br>
                                    <b>Ignici√≥n:</b> ${ignicion}<br>
                                    <b>Velocidad:</b> ${punto.velocidad} km/h<br>
                                    <b>Hora:</b> ${new Date(punto.fecha).toLocaleTimeString('es-CO')}
                                `);
                                markers.push(markerPunto);
                            }
                        });
                        
                        // Marcador inicio del viaje (Ignition ON)
                        const inicio = viaje.puntos[0];
                        const fin = viaje.puntos[viaje.puntos.length - 1];
                        
                        const markerInicio = L.marker([inicio.lat, inicio.lng], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="background: #34a853; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 11px;">${viaje.viaje_num}</div>`,
                                iconSize: [32, 32],
                                iconAnchor: [16, 16]
                            })
                        }).addTo(map).bindPopup(`
                            <b style="color: #34a853;">üü¢ IGNITION ON - Viaje ${viaje.viaje_num}</b><br>
                            <b>Punto #:</b> ${inicio.num || 1}<br>
                            <b>Velocidad:</b> ${inicio.velocidad} km/h<br>
                            <b>Hora:</b> ${new Date(inicio.fecha).toLocaleString('es-CO')}<br>
                            <b>Total puntos:</b> ${viaje.total_puntos || viaje.puntos.length}<br>
                            <hr style="margin: 5px 0; border: none; border-top: 1px solid #ddd;">
                            <b style="color: #ea4335;">üìç Punto Final:</b><br>
                            <b>Punto #:</b> ${fin.num || viaje.puntos.length}<br>
                            <b>Velocidad:</b> ${fin.velocidad} km/h<br>
                            <b>Hora:</b> ${new Date(fin.fecha).toLocaleString('es-CO')}
                        `);
                        markers.push(markerInicio);
                        
                        // Marcador fin del viaje (Ignition OFF)
                        const markerFin = L.marker([fin.lat, fin.lng], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="background: #ea4335; width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold;">OFF</div>`,
                                iconSize: [28, 28],
                                iconAnchor: [14, 14]
                            })
                        }).addTo(map).bindPopup(`
                            <b style="color: #ea4335;">üî¥ IGNITION OFF - Viaje ${viaje.viaje_num}</b><br>
                            <b>Punto #:</b> ${fin.num || viaje.puntos.length}<br>
                            <b>Velocidad:</b> ${fin.velocidad} km/h<br>
                            <b>Hora:</b> ${new Date(fin.fecha).toLocaleString('es-CO')}<br>
                            <hr style="margin: 5px 0; border: none; border-top: 1px solid #ddd;">
                            <b style="color: #34a853;">üìç Punto Inicial:</b><br>
                            <b>Punto #:</b> ${inicio.num || 1}<br>
                            <b>Velocidad:</b> ${inicio.velocidad} km/h<br>
                            <b>Hora:</b> ${new Date(inicio.fecha).toLocaleString('es-CO')}
                        `);
                        markers.push(markerFin);
                    }
                });
                
                if (allBounds.length > 0) {
                    map.fitBounds(allBounds, { padding: [50, 50] });
                }
                
                // Actualizar total de reportes del d√≠a
                let totalReportes = 0;
                data.viajes.forEach(v => totalReportes += v.puntos ? v.puntos.length : 0);
                document.getElementById('dia-reportes').textContent = totalReportes;
                
                // Actualizar leyenda con colores de viajes
                actualizarLeyendaViajes(data.viajes);
                
            } catch (error) {
                alert('Error cargando recorrido: ' + error.message);
            }
        }
                // Actualizar leyenda con colores de viajes
        function actualizarLeyendaViajes(viajes) {
            let legendHtml = '<strong>Viajes del d√≠a</strong>';
            viajes.forEach((viaje, index) => {
                const color = coloresViajes[index % coloresViajes.length];
                const horaInicio = new Date(viaje.inicio).toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit'});
                legendHtml += `
                    <div class="legend-item">
                        <span style="background: ${color}; width: 20px; height: 4px; border-radius: 2px; display: inline-block;"></span>
                        Viaje ${viaje.viaje_num} (${horaInicio})
                    </div>
                `;
            });
            document.querySelector('.legend').innerHTML = legendHtml;
        }
        
        // Funciones para selecci√≥n de viajes
        function toggleViajeSeleccion(index) {
            const tarjeta = document.querySelector(`.viaje-seleccionable[data-viaje-index="${index}"]`);
            if (tarjeta) {
                tarjeta.classList.toggle('seleccionado');
                mostrarViajesSeleccionados();
            }
        }
        
        function seleccionarTodosViajes(seleccionar) {
            const tarjetas = document.querySelectorAll('.viaje-seleccionable');
            tarjetas.forEach(tarjeta => {
                if (seleccionar) {
                    tarjeta.classList.add('seleccionado');
                } else {
                    tarjeta.classList.remove('seleccionado');
                }
            });
            mostrarViajesSeleccionados();
        }
        
        // Mostrar solo viajes seleccionados en el mapa
        async function mostrarViajesSeleccionados() {
            const placa = document.getElementById('select-placa').value;
            const fecha = document.getElementById('select-fecha').value;
            
            if (!placa || !fecha) {
                return;
            }
            
            // Obtener √≠ndices de viajes seleccionados
            const tarjetasSeleccionadas = document.querySelectorAll('.viaje-seleccionable.seleccionado');
            const indicesSeleccionados = Array.from(tarjetasSeleccionadas)
                .map(tarjeta => parseInt(tarjeta.dataset.viajeIndex));
            
            limpiarMapa();
            
            if (indicesSeleccionados.length === 0) {
                // Si no hay viajes seleccionados, solo limpia el mapa
                return;
            }
            
            try {
                const response = await fetch(`/api/recorrido?placa=${placa}&fecha=${fecha}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                if (!data.viajes || data.viajes.length === 0) {
                    alert('No hay datos de recorrido para esta fecha');
                    return;
                }
                
                const allBounds = [];
                
                // Dibujar solo los viajes seleccionados
                data.viajes.forEach((viaje, index) => {
                    if (!indicesSeleccionados.includes(index)) return; // Saltar si no est√° seleccionado
                    
                    const color = coloresViajes[index % coloresViajes.length];
                    const puntos = viaje.puntos.map(p => [p.lat, p.lng]);
                    
                    if (puntos.length > 0) {
                        // L√≠nea del viaje
                        const line = L.polyline(puntos, {
                            color: color,
                            weight: 4,
                            opacity: 0.8
                        }).addTo(map);
                        polylines.push(line);
                        
                        puntos.forEach(p => allBounds.push(p));
                        
                        // Puntos intermedios (cada reporte GPS)
                        viaje.puntos.forEach((punto, pIndex) => {
                            if (pIndex > 0 && pIndex < viaje.puntos.length - 1) {
                                const ignicion = punto.ignicion ? 'üü¢ Ignition ON' : 'üî¥ Ignition OFF';
                                const markerPunto = L.circleMarker([punto.lat, punto.lng], {
                                    radius: 6,
                                    fillColor: punto.ignicion ? color : '#666',
                                    color: '#fff',
                                    weight: 2,
                                    opacity: 1,
                                    fillOpacity: 0.9
                                }).addTo(map).bindPopup(`
                                    <b style="color: ${color};">üìç Punto #${punto.num || pIndex + 1}</b><br>
                                    <b>Viaje:</b> ${viaje.viaje_num}<br>
                                    <b>Ignici√≥n:</b> ${ignicion}<br>
                                    <b>Velocidad:</b> ${punto.velocidad} km/h<br>
                                    <b>Hora:</b> ${new Date(punto.fecha).toLocaleTimeString('es-CO')}
                                `);
                                markers.push(markerPunto);
                            }
                        });
                        
                        // Marcador inicio del viaje (Ignition ON)
                        const inicio = viaje.puntos[0];
                        const fin = viaje.puntos[viaje.puntos.length - 1];
                        
                        const markerInicio = L.marker([inicio.lat, inicio.lng], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="background: #34a853; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 11px;">${viaje.viaje_num}</div>`,
                                iconSize: [32, 32],
                                iconAnchor: [16, 16]
                            })
                        }).addTo(map).bindPopup(`
                            <b style="color: #34a853;">üü¢ IGNITION ON - Viaje ${viaje.viaje_num}</b><br>
                            <b>Punto #:</b> ${inicio.num || 1}<br>
                            <b>Velocidad:</b> ${inicio.velocidad} km/h<br>
                            <b>Hora:</b> ${new Date(inicio.fecha).toLocaleString('es-CO')}<br>
                            <b>Total puntos:</b> ${viaje.total_puntos || viaje.puntos.length}<br>
                            <hr style="margin: 5px 0; border: none; border-top: 1px solid #ddd;">
                            <b style="color: #ea4335;">üìç Punto Final:</b><br>
                            <b>Punto #:</b> ${fin.num || viaje.puntos.length}<br>
                            <b>Velocidad:</b> ${fin.velocidad} km/h<br>
                            <b>Hora:</b> ${new Date(fin.fecha).toLocaleString('es-CO')}
                        `);
                        markers.push(markerInicio);
                        
                        // Marcador fin del viaje (Ignition OFF)
                        const markerFin = L.marker([fin.lat, fin.lng], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="background: #ea4335; width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold;">OFF</div>`,
                                iconSize: [28, 28],
                                iconAnchor: [14, 14]
                            })
                        }).addTo(map).bindPopup(`
                            <b style="color: #ea4335;">üî¥ IGNITION OFF - Viaje ${viaje.viaje_num}</b><br>
                            <b>Punto #:</b> ${fin.num || viaje.puntos.length}<br>
                            <b>Velocidad:</b> ${fin.velocidad} km/h<br>
                            <b>Hora:</b> ${new Date(fin.fecha).toLocaleString('es-CO')}<br>
                            <hr style="margin: 5px 0; border: none; border-top: 1px solid #ddd;">
                            <b style="color: #34a853;">üìç Punto Inicial:</b><br>
                            <b>Punto #:</b> ${inicio.num || 1}<br>
                            <b>Velocidad:</b> ${inicio.velocidad} km/h<br>
                            <b>Hora:</b> ${new Date(inicio.fecha).toLocaleString('es-CO')}
                        `);
                        markers.push(markerFin);
                    }
                });
                
                if (allBounds.length > 0) {
                    map.fitBounds(allBounds, { padding: [50, 50] });
                }
                
                // Actualizar total de reportes solo de viajes seleccionados
                let totalReportes = 0;
                data.viajes.forEach((v, i) => {
                    if (indicesSeleccionados.includes(i)) {
                        totalReportes += v.puntos ? v.puntos.length : 0;
                    }
                });
                document.getElementById('dia-reportes').textContent = totalReportes;
                
                // Actualizar leyenda con solo viajes seleccionados
                const viajesSeleccionados = data.viajes.filter((v, i) => indicesSeleccionados.includes(i));
                actualizarLeyendaViajes(viajesSeleccionados);
                
            } catch (error) {
                alert('Error cargando recorrido: ' + error.message);
            }
        }
        
        // Limpiar mapa
        function limpiarMapa() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            if (polyline) {
                map.removeLayer(polyline);
                polyline = null;
            }
            // Limpiar todas las l√≠neas de viajes
            polylines.forEach(p => map.removeLayer(p));
            polylines = [];
            
            // Restaurar leyenda por defecto
            document.querySelector('.legend').innerHTML = `
                <strong>Leyenda</strong>
                <div class="legend-item">
                    <span class="status-dot online"></span> Comunicando
                </div>
                <div class="legend-item">
                    <span class="status-dot offline"></span> Sin comunicaci√≥n
                </div>
            `;
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            // Establecer fecha de hoy
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('select-fecha').value = hoy;
            
            cargarUbicaciones();
            cargarDispositivos();
        });
    </script>
</body>
</html>
